例：と多対多(User(1)-(n)Bookmarks(n)-(1)manga)の場合の場合で記述  
![image](https://github.com/user-attachments/assets/4b9e9325-8cad-42de-b88d-dbbf28a02bb0)　　⇒　　![image](https://github.com/user-attachments/assets/0c793869-f172-4a1c-9c3b-a1d9479dc232)
___
1、親モデル（今回の例ではUser）に『accepts_nested_attributes_for』の記述をし、親モデルのフォームを通じて子モデル（今回の例ではNote）の属性を受け取ることができるようにする。  
ユーザーモデル (User)
```
# app/models/user.rb
class User < ApplicationRecord
  has_many :bookmarks, dependent: :destroy  # 1対多の関係（ユーザーとブックマーク）
  has_many :mangas, through: :bookmarks  # 多対多の関係（ユーザーと漫画、中間テーブル：ブックマーク）

  accepts_nested_attributes_for :bookmarks, allow_destroy: true  # ネストされた属性を許可、多対多の中間テーブル
end
```
ブックマークモデル (Bookmark)
```
# app/models/bookmark.rb
class Bookmark < ApplicationRecord
  belongs_to :user
  belongs_to :manga
end
```
漫画モデル (Manga)
```
# app/models/manga.rb
class Manga < ApplicationRecord
  has_many :bookmarks, dependent: :destroy
  has_many :users, through: :bookmarks
end
```

2、必要なgemの追加
Gemfileに以下を追加します。

```
gem "importmap-rails"
gem "stimulus-rails"
```
その後、以下のコマンドを実行します。
```
bundle
```
3、importmap/stimulusのインストール
以下のコマンドを実行します。

```
docker compose run web rails importmap:install
docker compose run web rails stimulus:install
```
4、Stimulusコントローラの作成
以下のコマンドを実行してStimulusコントローラを作成します。  
※下記の[notes]の部分は任意のコントローラ名にする
```
rails g stimulus notes
```
作成されたnotes_controller.jsを以下のように編集します。

```
// 1対多の場合
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  static targets = ["container", "template"]

  addNote(event) { // メソッド名（notesに対応） - 1対多特有のメソッド名
    event.preventDefault()
    const content = this.templateTarget.innerHTML.replace(/TEMPLATE_RECORD/g, new Date().valueOf())
    this.containerTarget.insertAdjacentHTML("beforeend", content)
  }

  removeNote(event) { // メソッド名（notesに対応） - 1対多特有のメソッド名
    event.preventDefault()
    const field = event.target.closest(".nested-fields")
    if (this.containerTarget.childElementCount > 1) {
      field.querySelector("input[name*='_destroy']").value = 1
      field.style.display = "none"
    }
  }
}
```
5、フォームの編集
フォームのHTMLを以下のように編集します。
※下記のコメントアウトのあるコードの指定部分は実際のカラム名やテーブル名にする

```
<!--
テーブル情報
user(1)-(n)note
noteテーブル
└contentカラム
-->
<!-- [user]、[notes]、[note_form]、[data-notes-target]、[Note.new]、[notes#removeNote]、[content]、[notes#addNote]は実際のカラム名やテーブル名に変更要 -->
<%= form_with(model: user, html: { data: { controller: "notes" } }) do |form| %>
  <% if user.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(user.errors.count, "error") %> prohibited this user from being saved:</h2>
      <ul>
        <% user.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <h3>メモ</h3>
  <div data-notes-target="container">
    <%= form.fields_for :notes do |note_form| %>
      <div class="nested-fields">
        <%= note_form.hidden_field :_destroy %>
        <%= note_form.label :content, "メモ" %>
        <%= note_form.text_field :content %>
        <% if note_form.object && note_form.object.persisted? %>
          <a href="#" data-action="click->notes#removeNote">削除</a>
        <% end %>
      </div>
    <% end %>
    <% if user.notes.empty? %>
      <div class="nested-fields">
        <%= form.fields_for :notes, Note.new, child_index: "TEMPLATE_RECORD" do |note_form| %>
          <%= note_form.hidden_field :_destroy %>
          <%= note_form.label :content, "メモ" %>
          <%= note_form.text_field :content %>
        <% end %>
      </div>
    <% end %>
  </div>
  <a href="#" data-action="click->notes#addNote">追加</a>
  <template data-notes-target="template">
    <div class="nested-fields">
      <%= form.fields_for :notes, Note.new, child_index: "TEMPLATE_RECORD" do |note_form| %>
        <%= note_form.hidden_field :_destroy %>
        <%= note_form.label :content, "メモ" %>
        <%= note_form.text_field :content %>
        <a href="#" data-action="click->notes#removeNote">削除</a>
      <% end %>
    </div>
  </template>

  <div>
    <%= form.submit %>
  </div>
<% end %>
```
