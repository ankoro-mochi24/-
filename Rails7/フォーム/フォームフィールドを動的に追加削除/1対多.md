例：1対多(User(1)-(n)(Notes))の場合で記述  
![image](https://github.com/user-attachments/assets/cf50df71-3b7a-4e21-8e6f-ae7fe8b7cbee)　　⇒　　![image](https://github.com/user-attachments/assets/e39f4070-d82d-4f19-bc77-dd2bc12fd4d7)


___
1、モデルに『accepts_nested_attributes_for』の記述をし、親モデル（この場合はUser）のフォームを通じて子モデル（この場合はHobby）の属性を受け取ることができるようにする
ユーザーモデル (User)
```
# app/models/user.rb
class User < ApplicationRecord
  has_many :hobbies, dependent: :destroy
  accepts_nested_attributes_for :hobbies, allow_destroy: true
end
```
趣味モデル (Hobby)
```
# app/models/hobby.rb
class Hobby < ApplicationRecord
  belongs_to :user
end
```

2、必要なgemの追加
Gemfileに以下を追加します。

```
gem "importmap-rails"
gem "stimulus-rails"
```
その後、以下のコマンドを実行します。

```
bundle
```
3、importmap/stimulusのインストール
以下のコマンドを実行します。

```
docker compose run web rails importmap:install
docker compose run web rails stimulus:install
```
4、Stimulusコントローラの作成
以下のコマンドを実行してStimulusコントローラを作成します。  
※下記の[hobbies]の部分は任意のカラム名にする
```
rails g stimulus hobbies
```
作成されたhobbies_controller.jsを以下のように編集します。

```
import { Controller } from "@hotwired/stimulus"

// Connects to data-controller="hobbies"
export default class extends Controller {
  static targets = ["container", "template"]

  addField(event) {
    event.preventDefault()
    const content = this.templateTarget.innerHTML.replace(/TEMPLATE_RECORD/g, new Date().valueOf())
    this.containerTarget.insertAdjacentHTML("beforeend", content)
  }

  removeField(event) {
    event.preventDefault()
    if (this.containerTarget.childElementCount > 1) {
      event.target.closest(".nested-fields").remove()
    }
  }
}
```
5、フォームの編集
フォームのHTMLを以下のように編集します。
※下記の[user]、[hobbies]、[Hobby.new]、[hobby_form]の部分は任意のカラム名やテーブル名にする

```
<%= form_with(model: user, local: true) do |form| %>
...
  <h3>趣味</h3>
  <div data-controller="hobbies">
    <div data-hobbies-target="container">
      <%= form.fields_for :hobbies do |hobby_form| %>
        <div class="nested-fields">
          <%= hobby_form.label :name, "趣味" %>
          <%= hobby_form.text_field :name, value: hobby_form.object.name %>
          <a href="#" data-action="click->hobbies#removeField">-</a>
        </div>
      <% end %>
    </div>
    <a href="#" data-action="click->hobbies#addField">+</a>
    <template data-hobbies-target="template">
      <div class="nested-fields">
        <%= form.fields_for :hobbies, Hobby.new, child_index: "TEMPLATE_RECORD" do |hobby_form| %>
          <%= hobby_form.label :name, "趣味" %>
          <%= hobby_form.text_field :name %>
          <a href="#" data-action="click->hobbies#removeField">-</a>
        <% end %>
      </div>
    </template>
  </div>

  <div class="actions">
    <%= form.submit user.new_record? ? "登録" : "保存" %>
  </div>
<% end %>

```
